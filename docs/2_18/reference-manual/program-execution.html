<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stan Reference Manual</title>
  <meta name="description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Stan Reference Manual" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/logo_tm.png" />
  <meta property="og:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stan Reference Manual" />
  
  <meta name="twitter:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  <meta name="twitter:image" content="img/logo_tm.png" />

<meta name="author" content="Stan Development Team">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="language-syntax.html">
<link rel="next" href="deprecated-features-appendix.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="../stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em">Stan Reference Manual</li>

<li class="divider"></li>
<li><a href="index.html#overview"><i style="font-size: 110%; padding:1.5em 0 0 0; color:#990017;">Overview</i></a></li>
<li><a href="language.html#language"><i style="font-size: 110%; color:#990017;">Language</i></a></li>
<li class="chapter" data-level="1" data-path="character-encoding.html"><a href="character-encoding.html"><i class="fa fa-check"></i><b>1</b> Character Encoding</a></li>
<li class="chapter" data-level="2" data-path="includes-section.html"><a href="includes-section.html"><i class="fa fa-check"></i><b>2</b> Includes</a></li>
<li class="chapter" data-level="3" data-path="comments-section.html"><a href="comments-section.html"><i class="fa fa-check"></i><b>3</b> Comments</a></li>
<li class="chapter" data-level="4" data-path="whitespace.html"><a href="whitespace.html"><i class="fa fa-check"></i><b>4</b> Whitespace</a></li>
<li class="chapter" data-level="5" data-path="data-types-chapter.html"><a href="data-types-chapter.html"><i class="fa fa-check"></i><b>5</b> Data Types and Declarations</a></li>
<li class="chapter" data-level="6" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>6</b> Expressions</a></li>
<li class="chapter" data-level="7" data-path="statements.html"><a href="statements.html"><i class="fa fa-check"></i><b>7</b> Statements</a></li>
<li class="chapter" data-level="8" data-path="blocks-chapter.html"><a href="blocks-chapter.html"><i class="fa fa-check"></i><b>8</b> Program Blocks</a></li>
<li class="chapter" data-level="9" data-path="functions-chapter.html"><a href="functions-chapter.html"><i class="fa fa-check"></i><b>9</b> User-Defined Functions</a></li>
<li class="chapter" data-level="10" data-path="variable-transforms-chapter.html"><a href="variable-transforms-chapter.html"><i class="fa fa-check"></i><b>10</b> Constraint Transforms</a></li>
<li class="chapter" data-level="11" data-path="language-syntax.html"><a href="language-syntax.html"><i class="fa fa-check"></i><b>11</b> Language Syntax</a></li>
<li class="chapter" data-level="12" data-path="program-execution.html"><a href="program-execution.html"><i class="fa fa-check"></i><b>12</b> Program Execution</a></li>
<li class="chapter" data-level="13" data-path="deprecated-features-appendix.html"><a href="deprecated-features-appendix.html"><i class="fa fa-check"></i><b>13</b> Deprecated Features</a></li>
<li><a href="algorithms.html#algorithms"><i style="font-size: 110%; color:#990017;">Algorithms</i></a></li>
<li class="chapter" data-level="14" data-path="hmc-chapter.html"><a href="hmc-chapter.html"><i class="fa fa-check"></i><b>14</b> MCMC Sampling</a></li>
<li class="chapter" data-level="15" data-path="analysis-chapter.html"><a href="analysis-chapter.html"><i class="fa fa-check"></i><b>15</b> Posterior Analysis</a></li>
<li class="chapter" data-level="16" data-path="optimization-algorithms-chapter.html"><a href="optimization-algorithms-chapter.html"><i class="fa fa-check"></i><b>16</b> Optimization</a></li>
<li class="chapter" data-level="17" data-path="vi-algorithms-chapter.html"><a href="vi-algorithms-chapter.html"><i class="fa fa-check"></i><b>17</b> Variational Inference</a></li>
<li class="chapter" data-level="18" data-path="diagnostic-algorithms-chapter.html"><a href="diagnostic-algorithms-chapter.html"><i class="fa fa-check"></i><b>18</b> Diagnostic Mode</a></li>
<li><a href="usage.html#usage"><i style="font-size: 110%; color:#990017;">Usage</i></a></li>
<li class="chapter" data-level="19" data-path="reproducibility-chapter.html"><a href="reproducibility-chapter.html"><i class="fa fa-check"></i><b>19</b> Reproducibility</a></li>
<li class="chapter" data-level="20" data-path="licensing-appendix.html"><a href="licensing-appendix.html"><i class="fa fa-check"></i><b>20</b> Licenses and Dependencies</a></li>
<li><a href="references.html#references"><i style="font-size: 110%; color:#990017;">References</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan Reference Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="program-execution" class="section level1">
<h1><span class="header-section-number">12</span> Program Execution</h1>
<p>This chapter provides a sketch of how a compiled Stan model is
executed using sampling. Optimization shares the same data reading
and initialization steps, but then does optimization rather than sampling.</p>
<p>This sketch is elaborated in the following chapters of this part,
which cover variable declarations, expressions, statements, and blocks
in more detail.</p>
<div id="reading-and-transforming-data" class="section level2">
<h2><span class="header-section-number">12.1</span> Reading and Transforming Data</h2>
<p>The reading and transforming data steps are the same for sampling,
optimization and diagnostics.</p>
<div id="read-data" class="section level3 unnumbered">
<h3>Read Data</h3>
<p>The first step of execution is to read data into memory. Data may be
read in through file (in CmdStan) or through memory (RStan and
PyStan); see their respective manuals for details.<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a></p>
<p>All of the variables declared in the <code>data</code> block will be read.
If a variable cannot be read, the program will halt with a message
indicating which data variable is missing.</p>
<p>After each variable is read, if it has a declared constraint, the
constraint is validated. For example, if a variable <code>N</code> is
declared as <code>int&lt;lower=0&gt;</code>, after <code>N</code> is read, it will be tested
to make sure it is greater than or equal to zero. If a variable
violates its declared constraint, the program will halt with a warning
message indicating which variable contains an illegal value, the value
that was read, and the constraint that was declared.</p>
</div>
<div id="define-transformed-data" class="section level3 unnumbered">
<h3>Define Transformed Data</h3>
<p>After data is read into the model, the transformed data variable
statements are executed in order to define the transformed data
variables. As the statements execute, declared constraints on
variables are not enforced.</p>
<p>Transformed data variables are initialized with real values set to
<code>NaN</code> and integer values set to the smallest integer (large
absolute value negative number).</p>
<p>After the statements are executed, all declared constraints on
transformed data variables are validated. If the validation fails,
execution halts and the variable’s name, value and constraints are
displayed.</p>
</div>
</div>
<div id="initialization" class="section level2">
<h2><span class="header-section-number">12.2</span> Initialization</h2>
<p>Initialization is the same for sampling, optimization, and diagnosis</p>
<div id="user-supplied-initial-values" class="section level3 unnumbered">
<h3>User-Supplied Initial Values</h3>
<p>If there are user-supplied initial values for parameters, these are
read using the same input mechanism and same file format as data
reads. Any constraints declared on the parameters are validated for
the initial values. If a variable’s value violates its declared
constraint, the program halts and a diagnostic message is printed.</p>
<p>After being read, initial values are transformed to unconstrained
values that will be used to initialize the sampler.</p>
<div id="boundary-values-are-problematic" class="section level4 unnumbered">
<h4>Boundary Values are Problematic</h4>
<p>Because of the way Stan defines its transforms from the constrained to
the unconstrained space, initializing parameters on the boundaries of
their constraints is usually problematic. For instance, with a
constraint</p>
<pre class="stan"><code>parameters {
  real&lt;lower=0,upper=1&gt; theta;
  // ...
}</code></pre>
<p>an initial value of 0 for <code>theta</code> leads to an unconstrained value
of <span class="math inline">\(-\infty\)</span>, whereas a value of 1 leads to an unconstrained value of
<span class="math inline">\(+\infty\)</span>. While this will be inverse transformed back correctly
given the behavior of floating point arithmetic, the Jacobian will be
infinite and the log probability function will fail and raise an
exception.</p>
</div>
</div>
<div id="random-initial-values" class="section level3 unnumbered">
<h3>Random Initial Values</h3>
<p>If there are no user-supplied initial values, the default
initialization strategy is to initialize the unconstrained parameters
directly with values drawn uniformly from the interval <span class="math inline">\((-2,2)\)</span>. The
bounds of this initialization can be changed but it is always
symmetric around 0. The value of 0 is special in that it represents
the median of the initialization. An unconstrained value of 0
corresponds to different parameter values depending on the constraints
declared on the parameters.</p>
<p>An unconstrained real does not involve any transform, so an initial
value of 0 for the unconstrained parameters is also a value of 0 for
the constrained parameters.</p>
<p>For parameters that are bounded below at 0, the initial value of 0 on
the unconstrained scale corresponds to <span class="math inline">\(\exp(0) = 1\)</span> on the
constrained scale. A value of -2 corresponds to <span class="math inline">\(\exp(-2) = .13\)</span> and
a value of 2 corresponds to <span class="math inline">\(\exp(2) = 7.4\)</span>.</p>
<p>For parameters bounded above and below, the initial value of 0 on the
unconstrained scale corresponds to a value at the midpoint of the
constraint interval. For probability parameters, bounded below by 0
and above by 1, the transform is the inverse logit, so that an initial
unconstrained value of 0 corresponds to a constrained value of 0.5, -2
corresponds to 0.12 and 2 to 0.88. Bounds other than 0 and 1 are
just scaled and translated.</p>
<p>Simplexes with initial values of 0 on the unconstrained basis
correspond to symmetric values on the constrained values (i.e., each
value is <span class="math inline">\(1/K\)</span> in a <span class="math inline">\(K\)</span>-simplex).</p>
<p>Cholesky factors for positive-definite matrices are initialized to 1
on the diagonal and 0 elsewhere; this is because the diagonal is log
transformed and the below-diagonal values are unconstrained.</p>
<p>The initial values for other parameters can be determined from the
transform that is applied. The transforms are all described in full
detail in the <a href="variable-transforms-chapter.html#variable-transforms.chapter">chapter on variable transforms</a>.</p>
</div>
<div id="zero-initial-values" class="section level3 unnumbered">
<h3>Zero Initial Values</h3>
<p>The initial values may all be set to 0 on the unconstrained scale.
This can be helpful for diagnosis, and may also be a good starting
point for sampling. Once a model is running, multiple chains with
more diffuse starting points can help diagnose problems with
convergence; see the user’s guide for more information on
convergence monitoring.</p>
</div>
</div>
<div id="sampling" class="section level2">
<h2><span class="header-section-number">12.3</span> Sampling</h2>
<p>Sampling is based on simulating the Hamiltonian of a particle with a
starting position equal to the current parameter values and an initial
momentum (kinetic energy) generated randomly. The potential energy at
work on the particle is taken to be the negative log (unnormalized) total
probability function defined by the model. In the usual approach to
implementing HMC, the Hamiltonian dynamics of the particle is
simulated using the leapfrog integrator, which discretizes the smooth
path of the particle into a number of small time steps called leapfrog
steps.</p>
<div id="leapfrog-steps" class="section level3 unnumbered">
<h3>Leapfrog Steps</h3>
<p>For each leapfrog step, the negative log probability function and its
gradient need to be evaluated at the position corresponding to the
current parameter values (a more detailed sketch is provided in the
next section). These are used to update the momentum based on the
gradient and the position based on the momentum.</p>
<p>For simple models, only a few leapfrog steps with large step sizes are
needed. For models with complex posterior geometries, many small
leapfrog steps may be needed to accurately model the path of the
parameters.</p>
<p>If the user specifies the number of leapfrog steps (i.e., chooses to
use standard HMC), that number of leapfrog steps are simulated. If
the user has not specified the number of leapfrog steps, the No-U-Turn
sampler (NUTS) will determine the number of leapfrog steps adaptively
<span class="citation">(Hoffman and Gelman <a href="#ref-Hoffman-Gelman:2011">2011</a>)</span>, <span class="citation">(Hoffman and Gelman <a href="#ref-Hoffman-Gelman:2014">2014</a>)</span>.</p>
</div>
<div id="log-probability-and-gradient-calculation" class="section level3 unnumbered">
<h3>Log Probability and Gradient Calculation</h3>
<p>During each leapfrog step, the log probability function and its
gradient must be calculated. This is where most of the time in the
Stan algorithm is spent. This log probability function, which is
used by the sampling algorithm, is defined over the unconstrained
parameters.</p>
<p>The first step of the calculation requires the inverse transform of
the unconstrained parameter values back to the constrained parameters
in terms of which the model is defined. There is no error checking
required because the inverse transform is a total function on every point
in whose range satisfies the constraints.</p>
<p>Because the probability statements in the model are defined in terms
of constrained parameters, the log Jacobian of the inverse transform
must be added to the accumulated log probability.</p>
<p>Next, the transformed parameter statements are executed. After they
complete, any constraints declared for the transformed parameters are
checked. If the constraints are violated, the model will halt with a
diagnostic error message.</p>
<p>The final step in the log probability function calculation is to
execute the statements defined in the model block.</p>
<p>As the log probability function executes, it accumulates an in-memory
representation of the expression tree used to calculate the log
probability. This includes all of the transformed parameter
operations and all of the Jacobian adjustments. This tree is then
used to evaluate the gradients by propagating partial derivatives
backward along the expression graph. The gradient calculations
account for the majority of the cycles consumed by a Stan program.</p>
</div>
<div id="metropolis-acceptreject" class="section level3 unnumbered">
<h3>Metropolis Accept/Reject</h3>
<p>A standard Metropolis accept/reject step is required to retain detailed
balance and ensure draws are marginally distributed according to the
probability function defined by the model. This Metropolis adjustment
is based on comparing log probabilities, here defined by the
Hamiltonian, which is the sum of the potential (negative log
probability) and kinetic (squared momentum) energies. In theory, the
Hamiltonian is invariant over the path of the particle and rejection
should never occur. In practice, the probability of rejection is
determined by the accuracy of the leapfrog approximation to the true
trajectory of the parameters.</p>
<p>If step sizes are small, very few updates will be rejected, but many
steps will be required to move the same distance. If step sizes are
large, more updates will be rejected, but fewer steps will be required
to move the same distance. Thus a balance between effort and
rejection rate is required. If the user has not specified a step
size, Stan will tune the step size during warmup sampling to achieve
a desired rejection rate (thus balancing rejection versus number of
steps).</p>
<p>If the proposal is accepted, the parameters are updated to their new
values. Otherwise, the sample is the current set of parameter values.</p>
</div>
</div>
<div id="optimization" class="section level2">
<h2><span class="header-section-number">12.4</span> Optimization</h2>
<p>Optimization runs very much like sampling in that it starts by reading
the data and then initializing parameters. Unlike sampling, it
produces a deterministic output which requires no further analysis
other than to verify that the optimizer itself converged to a
posterior mode. The output for optimization is also similar to that
for sampling.</p>
</div>
<div id="variational-inference" class="section level2">
<h2><span class="header-section-number">12.5</span> Variational Inference</h2>
<p>Variational inference also runs similar to sampling. It begins by reading the
data and initializing the algorithm. The initial variational approximation is a
random draw from the standard normal distribution in the unconstrained
(real-coordinate) space. Again, similar to sampling, it outputs draws from the
approximate posterior once the algorithm has decided that it has converged.
Thus, the tools we use for analyzing the result of Stan’s sampling routines can
also be used for variational inference.</p>
</div>
<div id="model-diagnostics" class="section level2">
<h2><span class="header-section-number">12.6</span> Model Diagnostics</h2>
<p>Model diagnostics are like sampling and optimization in that they
depend on a model’s data being read and its parameters being
initialized. The user’s guides for the interfaces (RStan, PyStan,
CmdStan) provide more details on the diagnostics available; as of Stan
2.0, that’s just gradients on the unconstrained scale and log
probabilities.</p>
</div>
<div id="output" class="section level2">
<h2><span class="header-section-number">12.7</span> Output</h2>
<p>For each final draw (not counting draws during warmup or draws
that are thinned), there is an output stage of writing the draw.</p>
<div id="generated-quantities-1" class="section level3 unnumbered">
<h3>Generated Quantities</h3>
<p>Before generating any output, the statements in the generated quantities
block are executed. This can be used for any forward simulation based
on parameters of the model. Or it may be used to transform parameters
to an appropriate form for output.</p>
<p>After the generated quantities statements execute, the constraints
declared on generated quantities variables are validated. If these
constraints are violated, the program will terminate with a diagnostic message.</p>
</div>
<div id="write" class="section level3 unnumbered">
<h3>Write</h3>
<p>The final step is to write the actual values. The values of all
variables declared as parameters, transformed parameters, or generated
quantities are written. Local variables are not written, nor is the
data or transformed data. All values are written in their constrained
forms, that is the form that is used in the model definitions.</p>
<p>In the executable form of a Stan models, parameters, transformed
parameters, and generated quantities are written to a file in
comma-separated value (CSV) notation with a header defining
the names of the parameters (including indices for multivariate
parameters).<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a></p>

</div>
</div>
</div>
<h3><i style="font-size: 110%; color:#990017;">References</i></h3>
<div id="refs" class="references">
<div id="ref-Hoffman-Gelman:2011">
<p>Hoffman, Matthew D., and Andrew Gelman. 2011. “The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.” <em>arXiv</em> 1111.4246. <a href="http://arxiv.org/abs/1111.4246" class="uri">http://arxiv.org/abs/1111.4246</a>.</p>
</div>
<div id="ref-Hoffman-Gelman:2014">
<p>Hoffman, Matthew D., and Andrew Gelman. 2011. “The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.” <em>arXiv</em> 1111.4246. <a href="http://arxiv.org/abs/1111.4246" class="uri">http://arxiv.org/abs/1111.4246</a>.</p> 2014. “The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.” <em>Journal of Machine Learning Research</em> 15: 1593–1623. <a href="http://jmlr.org/papers/v15/hoffman14a.html" class="uri">http://jmlr.org/papers/v15/hoffman14a.html</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="18">
<li id="fn18"><p>The C++ code underlying Stan is flexible enough to allow data to be read from memory or file. Calls from R, for instance, can be configured to read data from file or directly from R’s memory.<a href="program-execution.html#fnref18" class="footnote-back">↩</a></p></li>
<li id="fn19"><p>In the R version of Stan, the values may either be written to a CSV file or directly back to R’s memory.<a href="program-execution.html#fnref19" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="language-syntax.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="deprecated-features-appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": false,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
