<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stan Reference Manual</title>
  <meta name="description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Stan Reference Manual" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/logo_tm.png" />
  <meta property="og:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stan Reference Manual" />
  
  <meta name="twitter:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  <meta name="twitter:image" content="img/logo_tm.png" />

<meta name="author" content="Stan Development Team">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="blocks-chapter.html">
<link rel="next" href="variable-transforms-chapter.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="../stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em">Stan Reference Manual</li>

<li class="divider"></li>
<li><a href="index.html#overview"><i style="font-size: 110%; padding:1.5em 0 0 0; color:#990017;">Overview</i></a></li>
<li><a href="language.html#language"><i style="font-size: 110%; color:#990017;">Language</i></a></li>
<li class="chapter" data-level="1" data-path="character-encoding.html"><a href="character-encoding.html"><i class="fa fa-check"></i><b>1</b> Character Encoding</a></li>
<li class="chapter" data-level="2" data-path="includes-section.html"><a href="includes-section.html"><i class="fa fa-check"></i><b>2</b> Includes</a></li>
<li class="chapter" data-level="3" data-path="comments-section.html"><a href="comments-section.html"><i class="fa fa-check"></i><b>3</b> Comments</a></li>
<li class="chapter" data-level="4" data-path="whitespace.html"><a href="whitespace.html"><i class="fa fa-check"></i><b>4</b> Whitespace</a></li>
<li class="chapter" data-level="5" data-path="data-types-chapter.html"><a href="data-types-chapter.html"><i class="fa fa-check"></i><b>5</b> Data Types and Declarations</a></li>
<li class="chapter" data-level="6" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>6</b> Expressions</a></li>
<li class="chapter" data-level="7" data-path="statements.html"><a href="statements.html"><i class="fa fa-check"></i><b>7</b> Statements</a></li>
<li class="chapter" data-level="8" data-path="blocks-chapter.html"><a href="blocks-chapter.html"><i class="fa fa-check"></i><b>8</b> Program Blocks</a></li>
<li class="chapter" data-level="9" data-path="functions-chapter.html"><a href="functions-chapter.html"><i class="fa fa-check"></i><b>9</b> User-Defined Functions</a></li>
<li class="chapter" data-level="10" data-path="variable-transforms-chapter.html"><a href="variable-transforms-chapter.html"><i class="fa fa-check"></i><b>10</b> Constraint Transforms</a></li>
<li class="chapter" data-level="11" data-path="language-syntax.html"><a href="language-syntax.html"><i class="fa fa-check"></i><b>11</b> Language Syntax</a></li>
<li class="chapter" data-level="12" data-path="program-execution.html"><a href="program-execution.html"><i class="fa fa-check"></i><b>12</b> Program Execution</a></li>
<li class="chapter" data-level="13" data-path="deprecated-features-appendix.html"><a href="deprecated-features-appendix.html"><i class="fa fa-check"></i><b>13</b> Deprecated Features</a></li>
<li><a href="algorithms.html#algorithms"><i style="font-size: 110%; color:#990017;">Algorithms</i></a></li>
<li class="chapter" data-level="14" data-path="hmc-chapter.html"><a href="hmc-chapter.html"><i class="fa fa-check"></i><b>14</b> MCMC Sampling</a></li>
<li class="chapter" data-level="15" data-path="analysis-chapter.html"><a href="analysis-chapter.html"><i class="fa fa-check"></i><b>15</b> Posterior Analysis</a></li>
<li class="chapter" data-level="16" data-path="optimization-algorithms-chapter.html"><a href="optimization-algorithms-chapter.html"><i class="fa fa-check"></i><b>16</b> Optimization</a></li>
<li class="chapter" data-level="17" data-path="vi-algorithms-chapter.html"><a href="vi-algorithms-chapter.html"><i class="fa fa-check"></i><b>17</b> Variational Inference</a></li>
<li class="chapter" data-level="18" data-path="diagnostic-algorithms-chapter.html"><a href="diagnostic-algorithms-chapter.html"><i class="fa fa-check"></i><b>18</b> Diagnostic Mode</a></li>
<li><a href="usage.html#usage"><i style="font-size: 110%; color:#990017;">Usage</i></a></li>
<li class="chapter" data-level="19" data-path="reproducibility-chapter.html"><a href="reproducibility-chapter.html"><i class="fa fa-check"></i><b>19</b> Reproducibility</a></li>
<li class="chapter" data-level="20" data-path="licensing-appendix.html"><a href="licensing-appendix.html"><i class="fa fa-check"></i><b>20</b> Licenses and Dependencies</a></li>
<li><a href="references.html#references"><i style="font-size: 110%; color:#990017;">References</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan Reference Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functions.chapter" class="section level1">
<h1><span class="header-section-number">9</span> User-Defined Functions</h1>
<p>Stan allows users to define their own functions. The basic syntax is
a simplified version of that used in C and C++. This chapter
specifies how functions are declared, defined, and used in Stan.</p>
<div id="function-definition-block" class="section level2">
<h2><span class="header-section-number">9.1</span> Function-Definition Block</h2>
<p>User-defined functions appear in a special function-definition block
before all of the other program blocks.</p>
<pre class="stan"><code>functions {
   // ... function declarations and definitions ...
}
data {
  // ...</code></pre>
<p>Function definitions and declarations may appear in any order, subject
to the condition that a function must be declared before it is used.
Forward declarations are allowed in order to support recursive
functions.</p>
</div>
<div id="function-names" class="section level2">
<h2><span class="header-section-number">9.2</span> Function Names</h2>
<p>The rules for function naming and function-argument naming are the
same as for other variables; see the <a href="expressions.html#variables.section">section on variables</a> for more
information on valid identifiers. For example,</p>
<pre class="stan"><code>real foo(real mu, real sigma);</code></pre>
<p>declares a function named <code>foo</code> with two argument variables of
types <code>real</code> and <code>real</code>. The arguments are named <code>mu</code>
and <code>sigma</code>, but that is not part of the declaration. Two
user-defined functions may <em>not</em> have the same name even if they have
different sequences of argument types.</p>
</div>
<div id="calling-functions" class="section level2">
<h2><span class="header-section-number">9.3</span> Calling Functions</h2>
<p>All function arguments are mandatory—there are no default values.</p>
<div id="functions-as-expressions" class="section level3 unnumbered">
<h3>Functions as Expressions</h3>
<p>Functions with non-void return types are called just like any other
built-in function in Stan—they are applied to appropriately typed
arguments to produce an expression, which has a value when executed.</p>
</div>
<div id="functions-as-statements" class="section level3 unnumbered">
<h3>Functions as Statements</h3>
<p>Functions with void return types may be applied to arguments and used
as statements. These act like sampling statements or print
statements. Such uses are only appropriate for functions that act
through side effects, such as incrementing the log probability
accumulator, printing, or raising exceptions.</p>
</div>
<div id="probability-functions-in-sampling-statements" class="section level3 unnumbered">
<h3>Probability Functions in Sampling Statements</h3>
<p>Functions whose name ends in <code>_lpdf</code> or <code>_lpmf</code> (density
and mass functions) may be used as probability functions and may be
used in place of parameterized distributions on the right-hand-side of
sampling statements. There is no restriction on where such functions
may be used.</p>
</div>
<div id="restrictions-on-placement" class="section level3 unnumbered">
<h3>Restrictions on Placement</h3>
<p>Functions of certain types are restricted on scope of usage.
Functions whose names end in <code>_lp</code> assume access to the log
probability accumulator and are only available in the transformed
parameter and model blocks. Functions whose names end in <code>_rng</code>
assume access to the random number generator and may only be used
within the generated quantities block, transformed data block, and
within user-defined functions ending in <code>_rng</code>. See
the <a href="functions-chapter.html#function-bodies.section">section on function bodies</a> for more information on these two special
types of function.</p>
</div>
</div>
<div id="argument-types-and-qualifiers" class="section level2">
<h2><span class="header-section-number">9.4</span> Argument Types and Qualifiers</h2>
<p>Stan’s functions all have declared types for both arguments and
returned value. As with built-in functions, user-defined functions are
only declared for base argument type and dimensionality. This
requires a different syntax than for declaring other variables. The
choice of language was made so that return types and argument types
could use the same declaration syntax.</p>
<p>The type <code>void</code> may not be used as an argument type, only a
return type for a function with side effects.</p>
<div id="base-variable-type-declaration" class="section level3 unnumbered">
<h3>Base Variable Type Declaration</h3>
<p>The base variable types are <code>integer</code>, <code>real</code>,
<code>vector</code>, <code>row_vector</code>, and <code>matrix</code>. No lower-bound
or upper-bound constraints are allowed (e.g., <code>real&lt;lower=0&gt;</code> is
illegal). Specialized types are also not allowed (e.g.,
<code>simplex</code> is illegal) .</p>
</div>
<div id="dimensionality-declaration" class="section level3 unnumbered">
<h3>Dimensionality Declaration</h3>
<p>Arguments and return types may be arrays, and these are indicated with
optional brackets and commas as would be used for indexing. For
example, <code>int</code> denotes a single integer argument or return,
whereas <code>real[ ]</code> indicates a one-dimensional array of reals,
<code>real[ , ]</code> a two-dimensional array and <code>real[ , , ]</code> a
three-dimensional array; whitespace is optional, as usual.</p>
<p>The dimensions for vectors and matrices are not included, so that
<code>matrix</code> is the type of a single matrix argument or return type.
Thus if a variable is declared as <code>matrix a</code>, then <code>a</code> has
two indexing dimensions, so that <code>a[1]</code> is a row vector and
<code>a[1, 1]</code> a real value. Matrices implicitly have two indexing
dimensions. The type declaration <code>matrix[ , ] b</code> specifies that
<code>b</code> is a two-dimensional array of matrices, for a total of four
indexing dimensions, with <code>b[1, 1, 1, 1]</code> picking out a real value.</p>
</div>
<div id="dimensionality-checks-and-exceptions" class="section level3 unnumbered">
<h3>Dimensionality Checks and Exceptions</h3>
<p>Function argument and return types are not themselves checked for
dimensionality. A matrix of any size may be passed in as a matrix
argument. Nevertheless, a user-defined function might call a function
(such as a multivariate normal density) that itself does
dimensionality checks.</p>
<p>Dimensions of function return values will be checked if they’re
assigned to a previously declared variable. They may also be checked
if they are used as the argument to a function.</p>
<p>Any errors raised by calls to functions inside user functions or
return type mismatches are simply passed on; this typically results
in a warning message and rejection of a proposal during sampling or
optimization.</p>
</div>
<div id="data-only-qualifiers" class="section level3 unnumbered">
<h3>Data-only Qualifiers</h3>
<p>Some of Stan’s built-in functions, like the differential equation
solvers, have arguments that must be data. Such data-only arguments
must be expressions involving only data, transformed data, and
generated quantity variables.</p>
<p>In user-defined functions, the qualifier <code>data</code> may be placed before
an argument type declaration to indicate that the argument must be
data only. For example,</p>
<pre><code>real foo(data real x) {
  return x^2;
}</code></pre>
<p>requires the argument <code>x</code> to be data only.</p>
<p>Declaring an argument data only allows type inference to proceed in
the body of the function so that, for example, the variable may be
used as a data-only argument to a built-in function.</p>
</div>
</div>
<div id="function-bodies.section" class="section level2">
<h2><span class="header-section-number">9.5</span> Function Bodies</h2>
<p>The body of a function is between an open curly brace (<code>{</code>) and
close curly brace (<code>}</code>). The body may contain local variable declarations at the
top of the function body’s block and these scope the same way as local
variables used in any other statement block.</p>
<p>The only restrictions on statements in function bodies are external,
and determine whether the log probability accumulator or random
number generators are available; see the rest of this section for details.</p>
<div id="random-number-generating-functions-1" class="section level3 unnumbered">
<h3>Random Number Generating Functions</h3>
<p>Functions that call random number generating functions in their bodies
must have a name that ends in <code>_rng</code>; attempts to use
random-number generators in other functions leads to a compile-time
error.</p>
<p>Like other random number generating functions, user-defined functions
with names that end in <code>_rng</code> may be used only in the generated
quantities block and transformed data block, or within the bodies of
user-defined functions ending in <code>_rng</code>. An attempt to use such
a function elsewhere results in a compile-time error.</p>
</div>
<div id="log-probability-access-in-functions" class="section level3 unnumbered">
<h3>Log Probability Access in Functions</h3>
<p>Functions that include sampling statements or log probability
increment statements must have a name that ends in <code>_lp</code>.
Attempts to use sampling statements or increment log probability
statements in other functions leads to a compile-time error.</p>
<p>Like the target log density increment statement and sampling
statements, user-defined functions with names that end in <code>_lp</code>
may only be used in blocks where the log probability accumulator is
accessible, namely the transformed parameters and model blocks. An
attempt to use such a function elsewhere results in a compile-time
error.</p>
</div>
<div id="defining-probability-functions-for-sampling-statements" class="section level3 unnumbered">
<h3>Defining Probability Functions for Sampling Statements</h3>
<p>Functions whose names end in <code>_lpdf</code> and <code>_lpmf</code> (density
and mass functions) can be used as probability functions in sampling
statements. As with the built-in functions, the first argument will
appear on the left of the sampling statement operator (<code>~</code>) in
the sampling statement and the other arguments follow. For example,
suppose a function returning the log of the density of <code>y</code> given
parameter <code>theta</code> allows the use of the sampling statement is
defined as follows.</p>
<pre class="stan"><code>real foo_lpdf(real y, vector theta) { ... }</code></pre>
<p>Note that for function definitions, the comma is used rather than the
vertical bar. Then the shorthand</p>
<pre class="stan"><code>z ~ foo(phi);</code></pre>
<p>will have exactly the same effect</p>
<pre class="stan"><code>target += foo_lpdf(z | phi);</code></pre>
<p>Unlike built-in probability functions, user-defined
probability functions like the example <code>foo</code> above will not
automatically drop constant terms.</p>
<p>The same syntax and shorthand works for log probability mass functions
with suffixes <code>_lpmf</code>.</p>
<p>A function that is going to be accessed as distributions must return
the log of the density or mass function it defines.</p>
</div>
</div>
<div id="parameters-are-constant" class="section level2">
<h2><span class="header-section-number">9.6</span> Parameters are Constant</h2>
<p>Within function definition bodies, the parameters may be used like any
other variable. But the parameters are constant in the sense that
they can’t be assigned to (i.e., can’t appear on the left side of an
assignment (<code>=</code>) statement)&lt;. In other words, their value remains
constant throughout the function body. Attempting to assign a value
to a function parameter value will raise a compile-time error.<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a></p>
<p>Local variables may be declared at the top of the function block and
scope as usual.</p>
</div>
<div id="function-returns.section" class="section level2">
<h2><span class="header-section-number">9.7</span> Return Value</h2>
<p>Non-void functions must have a return statement that returns an
appropriately typed expression. If the expression in a return
statement does not have the same type as the return type declared for
the function, a compile-time error is raised.</p>
<p>Void functions may use <code>return</code> only without an argument, but
return statements are not mandatory.</p>
<div id="return-guarantee-required" class="section level3 unnumbered">
<h3>Return Guarantee Required</h3>
<p>Unlike C++, Stan enforces a syntactic guarantee for non-void
functions that ensures control will leave a non-void function through
an appropriately typed return statement or because an exception is
raised in the execution of the function. To enforce this condition,
functions must have a return statement as the last statement in their
body. This notion of last is defined recursively in terms of
statements that qualify as bodies for functions. The base case is that</p>
<ul>
<li>a return statement qualifies,</li>
</ul>
<p>and the recursive cases are that</p>
<ul>
<li>a sequence of statements qualifies if its last statement
qualifies,</li>
<li>a for loop or while loop qualifies if its body qualifies, and</li>
<li>a conditional statement qualifies if it has a default else
clause and all of its body statements qualify.</li>
</ul>
<p>These rules disqualify</p>
<pre class="stan"><code>real foo(real x) {
  if (x &gt; 2) return 1.0;
  else if (x &lt;= 2) return -1.0;
}</code></pre>
<p>because there is no default <code>else</code> clause, and disqualify</p>
<pre class="stan"><code>real foo(real x) {
  real y;
  y = x;
  while (x &lt; 10) {
    if (x &gt; 0) return x;
    y = x / 2;
  }
}</code></pre>
<p>because the return statement is not the last statement in the while
loop. A bogus dummy return could be placed after the while loop in
this case. The rules for returns allow</p>
<pre class="stan"><code>real log_fancy(real x) {
  if (x &lt; 1e-30)
    return x;
  else if (x &lt; 1e-14)
    return x * x;
  else
    return log(x);
}</code></pre>
<p>because there’s a default else clause and each condition body has
return as its final statement.</p>
</div>
</div>
<div id="void-functions-as-statements" class="section level2">
<h2><span class="header-section-number">9.8</span> Void Functions as Statements</h2>
<div id="void-functions" class="section level3 unnumbered">
<h3>Void Functions</h3>
<p>A function can be declared without a return value by using <code>void</code>
in place of a return type. Note that the type <code>void</code> may only be
used as a return type—arguments may not be declared to be of type
<code>void</code>.</p>
</div>
<div id="usage-as-statement" class="section level3 unnumbered">
<h3>Usage as Statement</h3>
<p>A void function may be used as a statement after the function is
declared; see the <a href="functions-chapter.html#forward-declarations.section">section on forward declarations</a> for rules on declaration.</p>
<p>Because there is no return, such a usage is only for side effects,
such as incrementing the log probability function, printing, or
raising an error.</p>
</div>
<div id="special-return-statements" class="section level3 unnumbered">
<h3>Special Return Statements</h3>
<p>In a return statement within a void function’s definition, the
<code>return</code> keyword is followed immediately by a semicolon
(<code>;</code>) rather than by the expression whose value is returned.</p>
</div>
</div>
<div id="forward-declarations.section" class="section level2">
<h2><span class="header-section-number">9.9</span> Declarations</h2>
<p>In general, functions must be declared before they are used. Stan
supports forward declarations, which look like function definitions
without bodies. For example,</p>
<pre class="stan"><code>real unit_normal_lpdf(real y);</code></pre>
<p>declares a function named <code>unit_normal_log</code> that consumes a
single real-valued input and produces a real-valued output. A
function definition with a body simultaneously declares and defines
the named function, as in</p>
<pre class="stan"><code>real unit_normal_lpdf(real y) {
  return -0.5 * square(y);
}</code></pre>
<p>A user-defined Stan function may be declared and then later defined,
or just defined without being declared. No other combination of
declaration and definition is legal, so that, for instance, a function
may not be declared more than once, nor may it be defined more than
once. If there is a declaration, there must be a definition. These
rules together ensure that all the declared functions are eventually
defined.</p>
<div id="recursive-functions" class="section level3 unnumbered">
<h3>Recursive Functions</h3>
<p>Forward declarations allow the definition of self-recursive or
mutually recursive functions. For instance, consider the following
code to compute Fibonacci numbers.</p>
<pre class="stan"><code>int fib(int n);

int fib(int n) {
  if (n &lt; 2) return n;
  else return fib(n-1) + fib(n-2);
}</code></pre>
<p>Without the forward declaration in the first line, the body of the
definition would not compile.</p>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="14">
<li id="fn14"><p>Despite being declared constant and appearing to have a pass-by-value syntax in Stan, the implementation of the language passes function arguments by constant reference in C++.<a href="functions-chapter.html#fnref14" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="blocks-chapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="variable-transforms-chapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
