<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stan User’s Guide</title>
  <meta name="description" content="Stan user’s guide with examples and programming techniques.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Stan User’s Guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/logo-tm.pdf" />
  <meta property="og:description" content="Stan user’s guide with examples and programming techniques." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stan User’s Guide" />
  
  <meta name="twitter:description" content="Stan user’s guide with examples and programming techniques." />
  <meta name="twitter:image" content="img/logo-tm.pdf" />

<meta name="author" content="Stan Development Team">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="gaussian-processes-chapter.html">
<link rel="next" href="algebra-solver-chapter.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em">Stan User's Guide</li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this Book</a></li>
<li><a href="example-models-part.html#example-models.part"><i style="font-size: 110%; color:#990017;">Part 1. Example Models</i></span></a></li>
<li class="chapter" data-level="1" data-path="regression-models.html"><a href="regression-models.html"><i class="fa fa-check"></i><b>1</b> Regression Models</a></li>
<li class="chapter" data-level="2" data-path="time-series-chapter.html"><a href="time-series-chapter.html"><i class="fa fa-check"></i><b>2</b> Time-Series Models</a></li>
<li class="chapter" data-level="3" data-path="missing-data-and-partially-known-parameters.html"><a href="missing-data-and-partially-known-parameters.html"><i class="fa fa-check"></i><b>3</b> Missing Data and Partially Known Parameters</a></li>
<li class="chapter" data-level="4" data-path="truncated-or-censored-data.html"><a href="truncated-or-censored-data.html"><i class="fa fa-check"></i><b>4</b> Truncated or Censored Data</a></li>
<li class="chapter" data-level="5" data-path="mixture-modeling-chapter.html"><a href="mixture-modeling-chapter.html"><i class="fa fa-check"></i><b>5</b> Finite Mixtures</a></li>
<li class="chapter" data-level="6" data-path="measurement-error-and-meta-analysis.html"><a href="measurement-error-and-meta-analysis.html"><i class="fa fa-check"></i><b>6</b> Measurement Error and Meta-Analysis</a></li>
<li class="chapter" data-level="7" data-path="latent-discrete-chapter.html"><a href="latent-discrete-chapter.html"><i class="fa fa-check"></i><b>7</b> Latent Discrete Parameters</a></li>
<li class="chapter" data-level="8" data-path="sparse-ragged-chapter.html"><a href="sparse-ragged-chapter.html"><i class="fa fa-check"></i><b>8</b> Sparse and Ragged Data Structures</a></li>
<li class="chapter" data-level="9" data-path="clustering-chapter.html"><a href="clustering-chapter.html"><i class="fa fa-check"></i><b>9</b> Clustering Models</a></li>
<li class="chapter" data-level="10" data-path="gaussian-processes-chapter.html"><a href="gaussian-processes-chapter.html"><i class="fa fa-check"></i><b>10</b> Gaussian Processes</a></li>
<li class="chapter" data-level="11" data-path="directions-rotations-and-hyperspheres.html"><a href="directions-rotations-and-hyperspheres.html"><i class="fa fa-check"></i><b>11</b> Directions, Rotations, and Hyperspheres</a></li>
<li class="chapter" data-level="12" data-path="algebra-solver-chapter.html"><a href="algebra-solver-chapter.html"><i class="fa fa-check"></i><b>12</b> Solving Algebraic Equations</a></li>
<li class="chapter" data-level="13" data-path="ode-solver-chapter.html"><a href="ode-solver-chapter.html"><i class="fa fa-check"></i><b>13</b> Ordinary Differential Equations</a></li>
<li><a href="part-2-programming-techniques.html#part-2.-programming-techniques"><i style="font-size: 110%; color:#990017;">Part 2. Programming Techniques</i></a></li>
<li class="chapter" data-level="14" data-path="floating-point-arithmetic.html"><a href="floating-point-arithmetic.html"><i class="fa fa-check"></i><b>14</b> Floating Point Arithmetic</a></li>
<li class="chapter" data-level="15" data-path="matrices-vectors-and-arrays.html"><a href="matrices-vectors-and-arrays.html"><i class="fa fa-check"></i><b>15</b> Matrices, Vectors, and Arrays</a></li>
<li class="chapter" data-level="16" data-path="multi-indexing-chapter.html"><a href="multi-indexing-chapter.html"><i class="fa fa-check"></i><b>16</b> Multiple Indexing and Range Indexing</a></li>
<li class="chapter" data-level="17" data-path="functions-programming-chapter.html"><a href="functions-programming-chapter.html"><i class="fa fa-check"></i><b>17</b> User-Defined Functions</a></li>
<li class="chapter" data-level="18" data-path="custom-probability-functions-chapter.html"><a href="custom-probability-functions-chapter.html"><i class="fa fa-check"></i><b>18</b> Custom Probability Functions</a></li>
<li class="chapter" data-level="19" data-path="problematic-posteriors-chapter.html"><a href="problematic-posteriors-chapter.html"><i class="fa fa-check"></i><b>19</b> Problematic Posteriors</a></li>
<li class="chapter" data-level="20" data-path="change-of-variables-chapter.html"><a href="change-of-variables-chapter.html"><i class="fa fa-check"></i><b>20</b> Reparameterization and Change of Variables</a></li>
<li class="chapter" data-level="21" data-path="optimization-chapter.html"><a href="optimization-chapter.html"><i class="fa fa-check"></i><b>21</b> Efficiency Tuning</a></li>
<li class="chapter" data-level="22" data-path="map-reduce-chapter.html"><a href="map-reduce-chapter.html"><i class="fa fa-check"></i><b>22</b> Map-Reduce</a></li>
<li><a href="appendices.html#appendices"><i style="font-size: 110%; color:#990017;">Appendices</i></a></li>
<li class="chapter" data-level="" data-path="appendix-1-stan-program-style-guide.html"><a href="appendix-1-stan-program-style-guide.html"><i class="fa fa-check"></i>Appendix 1. Stan Program Style Guide</a></li>
<li class="chapter" data-level="" data-path="stan-for-bugs-appendix.html"><a href="stan-for-bugs-appendix.html"><i class="fa fa-check"></i>Appendix 2. Transitioning from BUGS</a></li>
<li><a href="references.html#references"><i style="font-size: 110%; color:#990017;">References</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan User’s Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="directions-rotations-and-hyperspheres" class="section level1">
<h1><span class="header-section-number">11</span> Directions, Rotations, and Hyperspheres</h1>
<p>Directional statistics involve data and/or parameters that are
constrained to be directions. The set of directions forms a sphere,
the geometry of which is not smoothly mappable to that of a Euclidean
space because you can move around a sphere and come back to where you
started. This is why it is impossible to make a map of the globe on a
flat piece of paper where all points that are close to each other on
the globe are close to each other on the flat map. The fundamental
problem is easy to visualize in two dimensions, because as you move
around a circle, you wind up back where you started. In other words,
0 degrees and 360 degrees (equivalently, 0 and <span class="math inline">\(2 \pi\)</span> radians) pick
out the same point, and the distance between 359 degrees and 2 degrees
is the same as the distance between 137 and 140 degrees.</p>
<p>Stan supports directional statistics by providing a unit-vector data
type, the values of which determine points on a hypersphere (circle in
two dimensions, sphere in three dimensions).</p>
<div id="unit-vectors" class="section level2">
<h2><span class="header-section-number">11.1</span> Unit Vectors</h2>
<p>The length of a vector <span class="math inline">\(x \in \mathbb{R}^K\)</span> is given by
<span class="math display">\[
\Vert x \Vert
\ = \ \sqrt{x^{\top}\,x}
\ = \ \sqrt{x_1^2 + x_2^2 + \cdots + x_K^2}.
\]</span>
Unit vectors are defined to be vectors of unit length (i.e., length
one).</p>
<p>With a variable declaration such as</p>
<pre><code>unit_vector[K] x;</code></pre>
<p>the value of <code>x</code> will be constrained to be a vector of size
<code>K</code> with unit length; the reference manual chapter on
constrained parameter transforms provides precise definitions.</p>
<p><em>Warning:</em> An extra term gets added to the log density to ensure
the distribution on unit vectors is proper. This is not a problem in
practice, but it may lead to misunderstandings of the target log
density output (<code>lp__</code> in some interfaces). The underlying
source of the problem is that a unit vector of size <span class="math inline">\(K\)</span> has only
<span class="math inline">\(K - 1\)</span> degrees of freedom. But there is no way to map those <span class="math inline">\(K - 1\)</span>
degrees of freedom continuously to <span class="math inline">\(\mathbb{R}^N\)</span>—for example, the
circle can’t be mapped continuously to a line so the limits work out,
nor can a sphere be mapped to a plane. A workaround is needed
instead. Stan’s unit vector transform uses <span class="math inline">\(K\)</span> unconstrained
variables, then projects down to the unit hypersphere. Even though
the hypersphere is compact, the result would be an improper
distribution. To ensure the unit vector distribution is proper, each
unconstrained variable is given a “Jacobian” adjustment equal to an
independent standard normal distribution. Effectively, each dimension is
drawn standard normal, then they are together projected down to the
hypersphere to produce a unit vector. The result is a proper uniform
distribution over the hypersphere.</p>
</div>
<div id="circles-spheres-and-hyperspheres" class="section level2">
<h2><span class="header-section-number">11.2</span> Circles, Spheres, and Hyperspheres</h2>
<p>An <span class="math inline">\(n\)</span>-sphere, written <span class="math inline">\(S^{n}\)</span>, is defined as the set of <span class="math inline">\((n + 1)\)</span>-dimensional unit vectors,
<span class="math display">\[
S^{n} = \{ x \in \mathbb{R}^{n+1} \, : \, \Vert x \Vert = 1 \}.
\]</span></p>
<p>Even though <span class="math inline">\(S^n\)</span> is made up of points in <span class="math inline">\((n+1)\)</span> dimensions, it is
only an <span class="math inline">\(n\)</span>-dimensional manifold. For example, <span class="math inline">\(S^2\)</span> is defined as a
set of points in <span class="math inline">\(\mathbb{R}^3\)</span>, but each such point may be described
uniquely by a latitude and longitude. Geometrically, the surface
defined by <span class="math inline">\(S^2\)</span> in <span class="math inline">\(\mathbb{R}^3\)</span> behaves locally like a plane, i.e.,
<span class="math inline">\(\mathbb{R}^2\)</span>. However, the overall shape of <span class="math inline">\(S^2\)</span> is not like a plane
in that is compact (i.e., there is a maximum distance between points).
If you set off around the globe in a “straight line” (i.e., a
geodesic), you wind up back where you started eventually; that is why
the geodesics on the sphere (<span class="math inline">\(S^2\)</span>) are called “great circles,” and
why we need to use some clever representations to do circular or
spherical statistics.</p>
<p>Even though <span class="math inline">\(S^{n-1}\)</span> behaves locally like <span class="math inline">\(\mathbb{R}^{n-1}\)</span>, there is no
way to smoothly map between them. For example, because
latitude and longitude work on a modular basis (wrapping at <span class="math inline">\(2\pi\)</span>
radians in natural units), they do not produce a smooth map.</p>
<p>Like a bounded interval <span class="math inline">\((a, b)\)</span>, in geometric terms, a sphere is
compact in that the distance between any two points is bounded.</p>
</div>
<div id="transforming-to-unconstrained-parameters" class="section level2">
<h2><span class="header-section-number">11.3</span> Transforming to Unconstrained Parameters</h2>
<p>Stan (inverse) transforms arbitrary points in <span class="math inline">\(\mathbb{R}^{K+1}\)</span> to points
in <span class="math inline">\(S^K\)</span> using the auxiliary variable approach of
<span class="citation">Marsaglia (<a href="#ref-Marsaglia:1972">1972</a>)</span>. A point <span class="math inline">\(y \in \mathbb{R}^K\)</span> is transformed to a
point <span class="math inline">\(x \in S^{K-1}\)</span> by</p>
<p><span class="math display">\[
x = \frac{y}{\sqrt{y^{\top} y}}.
\]</span></p>
<p>The problem with this mapping is that it’s many to one; any point
lying on a vector out of the origin is projected to the same point on
the surface of the sphere. <span class="citation">Marsaglia (<a href="#ref-Marsaglia:1972">1972</a>)</span> introduced an
auxiliary variable interpretation of this mapping that provides the
desired properties of uniformity; the reference manual contains the
precise definitions used in the chapter on constrained parameter
transforms.</p>
<div id="warning-undefined-at-zero" class="section level4 unnumbered">
<h4>Warning: undefined at zero!</h4>
<p>The above mapping from <span class="math inline">\(\mathbb{R}^n\)</span> to <span class="math inline">\(S^n\)</span> is not defined at zero.
While this point outcome has measure zero during sampling, and may
thus be ignored, it is the default initialization point and thus unit
vector parameters cannot be initialized at zero. A simple workaround
is to initialize from a small interval around zero, which is an
option built into all of the Stan interfaces.</p>
</div>
</div>
<div id="unit-vectors-and-rotations" class="section level2">
<h2><span class="header-section-number">11.4</span> Unit Vectors and Rotations</h2>
<p>Unit vectors correspond directly to angles and thus to rotations.
This is easy to see in two dimensions, where a point on a circle
determines a compass direction, or equivalently, an angle <span class="math inline">\(\theta\)</span>).
Given an angle <span class="math inline">\(\theta\)</span>, a matrix can be defined, the
pre-multiplication by which rotates a point by an angle of <span class="math inline">\(\theta\)</span>.
For angle <span class="math inline">\(\theta\)</span> (in two dimensions), the <span class="math inline">\(2 \times 2\)</span> rotation
matrix is defined by
<span class="math display">\[
R_{\theta}
=
\begin{bmatrix}
\cos \theta &amp; - \sin \theta
\\
\sin \theta &amp; \cos \theta
\end{bmatrix}.
\]</span>
Given a two-dimensional vector <span class="math inline">\(x\)</span>, <span class="math inline">\(R_{\theta} \, x\)</span> is the rotation
of <span class="math inline">\(x\)</span> (around the origin) by <span class="math inline">\(\theta\)</span> degrees.</p>
<div id="unit-vector-type" class="section level3 unnumbered">
<h3>Unit vector type</h3>
<p>In Stan, unit vectors in <span class="math inline">\(K\)</span> dimensions are declared as</p>
<pre><code>unit_vector[K] alpha;</code></pre>
<p>A unit vector has length one (meaning the sum of squared values is
one, not that its number of elements is one).</p>
</div>
<div id="angles-from-unit-vectors" class="section level3 unnumbered">
<h3>Angles from unit vectors</h3>
<p>Angles can be calculated from unit vectors. For example, a random
variable <code>theta</code> representing an angle in <span class="math inline">\((-\pi, \pi)\)</span> radians
can be declared as a two-dimensional unit vector then transformed to
an angle.</p>
<pre><code>parameters {
  unit_vector[2] xy;

transformed parameters {
  real&lt;lower = -pi(), upper = pi&gt; theta = atan2(xy[2], xy[1]);</code></pre>
<p>If the distribution of <span class="math inline">\((x, y)\)</span> is uniform over a circle, then the
distribution of <span class="math inline">\(\arctan \frac{y}{x}\)</span> is uniform over <span class="math inline">\((-\pi, pi]\)</span>.</p>
<p>It might be tempting to try to just declare theta directly as a
parameter with the lower and upper bound constraint as given above.
The drawback to this approach is that the values <span class="math inline">\(-\pi\)</span> and <span class="math inline">\(\pi\)</span> are
at <span class="math inline">\(-\infty\)</span> and <span class="math inline">\(\infty\)</span> on the unconstrained scale, which can
produce multimodal posterior distribtions when the true distribution
on the circle is unimodal.</p>
<p>With a little additional work on the trigonometric front, the same
conversion back to angles may be accomplished in more dimensions.</p>
</div>
</div>
<div id="circular-representations-of-days-and-years" class="section level2">
<h2><span class="header-section-number">11.5</span> Circular Representations of Days and Years</h2>
<p>A 24-hour clock naturally represents the progression of time through
the day, moving from midnight to noon and back again in one rotation.
A point on a circle divided into 24 hours is thus a natural
representation for the time of day. Similarly, years cycle through
the seasons and return to the season from which they started.</p>
<p>In human affairs, temporal effects often arise by convention. These
can be modeled directly with ad-hoc predictors for holidays and
weekends, or with data normalization back to natural scales for
daylight savings time.</p>

</div>
</div>
<h3><i style="font-size: 110%; color:#990017;">References</i></h3>
<div id="refs" class="references">
<div id="ref-Marsaglia:1972">
<p>Marsaglia, George. 1972. “Choosing a Point from the Surface of a Sphere.” <em>The Annals of Mathematical Statistics</em> 43 (2): 645–46.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="gaussian-processes-chapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="algebra-solver-chapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
