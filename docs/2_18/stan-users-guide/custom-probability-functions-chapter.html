<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stan User’s Guide</title>
  <meta name="description" content="Stan user’s guide with examples and programming techniques.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Stan User’s Guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/logo-tm.pdf" />
  <meta property="og:description" content="Stan user’s guide with examples and programming techniques." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stan User’s Guide" />
  
  <meta name="twitter:description" content="Stan user’s guide with examples and programming techniques." />
  <meta name="twitter:image" content="img/logo-tm.pdf" />

<meta name="author" content="Stan Development Team">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="functions-programming-chapter.html">
<link rel="next" href="problematic-posteriors-chapter.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em">Stan User's Guide</li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this Book</a></li>
<li><a href="example-models-part.html#example-models.part"><i style="font-size: 110%; color:#990017;">Part 1. Example Models</i></span></a></li>
<li class="chapter" data-level="1" data-path="regression-models.html"><a href="regression-models.html"><i class="fa fa-check"></i><b>1</b> Regression Models</a></li>
<li class="chapter" data-level="2" data-path="time-series-chapter.html"><a href="time-series-chapter.html"><i class="fa fa-check"></i><b>2</b> Time-Series Models</a></li>
<li class="chapter" data-level="3" data-path="missing-data-and-partially-known-parameters.html"><a href="missing-data-and-partially-known-parameters.html"><i class="fa fa-check"></i><b>3</b> Missing Data and Partially Known Parameters</a></li>
<li class="chapter" data-level="4" data-path="truncated-or-censored-data.html"><a href="truncated-or-censored-data.html"><i class="fa fa-check"></i><b>4</b> Truncated or Censored Data</a></li>
<li class="chapter" data-level="5" data-path="mixture-modeling-chapter.html"><a href="mixture-modeling-chapter.html"><i class="fa fa-check"></i><b>5</b> Finite Mixtures</a></li>
<li class="chapter" data-level="6" data-path="measurement-error-and-meta-analysis.html"><a href="measurement-error-and-meta-analysis.html"><i class="fa fa-check"></i><b>6</b> Measurement Error and Meta-Analysis</a></li>
<li class="chapter" data-level="7" data-path="latent-discrete-chapter.html"><a href="latent-discrete-chapter.html"><i class="fa fa-check"></i><b>7</b> Latent Discrete Parameters</a></li>
<li class="chapter" data-level="8" data-path="sparse-ragged-chapter.html"><a href="sparse-ragged-chapter.html"><i class="fa fa-check"></i><b>8</b> Sparse and Ragged Data Structures</a></li>
<li class="chapter" data-level="9" data-path="clustering-chapter.html"><a href="clustering-chapter.html"><i class="fa fa-check"></i><b>9</b> Clustering Models</a></li>
<li class="chapter" data-level="10" data-path="gaussian-processes-chapter.html"><a href="gaussian-processes-chapter.html"><i class="fa fa-check"></i><b>10</b> Gaussian Processes</a></li>
<li class="chapter" data-level="11" data-path="directions-rotations-and-hyperspheres.html"><a href="directions-rotations-and-hyperspheres.html"><i class="fa fa-check"></i><b>11</b> Directions, Rotations, and Hyperspheres</a></li>
<li class="chapter" data-level="12" data-path="algebra-solver-chapter.html"><a href="algebra-solver-chapter.html"><i class="fa fa-check"></i><b>12</b> Solving Algebraic Equations</a></li>
<li class="chapter" data-level="13" data-path="ode-solver-chapter.html"><a href="ode-solver-chapter.html"><i class="fa fa-check"></i><b>13</b> Ordinary Differential Equations</a></li>
<li><a href="part-2-programming-techniques.html#part-2.-programming-techniques"><i style="font-size: 110%; color:#990017;">Part 2. Programming Techniques</i></a></li>
<li class="chapter" data-level="14" data-path="floating-point-arithmetic.html"><a href="floating-point-arithmetic.html"><i class="fa fa-check"></i><b>14</b> Floating Point Arithmetic</a></li>
<li class="chapter" data-level="15" data-path="matrices-vectors-and-arrays.html"><a href="matrices-vectors-and-arrays.html"><i class="fa fa-check"></i><b>15</b> Matrices, Vectors, and Arrays</a></li>
<li class="chapter" data-level="16" data-path="multi-indexing-chapter.html"><a href="multi-indexing-chapter.html"><i class="fa fa-check"></i><b>16</b> Multiple Indexing and Range Indexing</a></li>
<li class="chapter" data-level="17" data-path="functions-programming-chapter.html"><a href="functions-programming-chapter.html"><i class="fa fa-check"></i><b>17</b> User-Defined Functions</a></li>
<li class="chapter" data-level="18" data-path="custom-probability-functions-chapter.html"><a href="custom-probability-functions-chapter.html"><i class="fa fa-check"></i><b>18</b> Custom Probability Functions</a></li>
<li class="chapter" data-level="19" data-path="problematic-posteriors-chapter.html"><a href="problematic-posteriors-chapter.html"><i class="fa fa-check"></i><b>19</b> Problematic Posteriors</a></li>
<li class="chapter" data-level="20" data-path="change-of-variables-chapter.html"><a href="change-of-variables-chapter.html"><i class="fa fa-check"></i><b>20</b> Reparameterization and Change of Variables</a></li>
<li class="chapter" data-level="21" data-path="optimization-chapter.html"><a href="optimization-chapter.html"><i class="fa fa-check"></i><b>21</b> Efficiency Tuning</a></li>
<li class="chapter" data-level="22" data-path="map-reduce-chapter.html"><a href="map-reduce-chapter.html"><i class="fa fa-check"></i><b>22</b> Map-Reduce</a></li>
<li><a href="appendices.html#appendices"><i style="font-size: 110%; color:#990017;">Appendices</i></a></li>
<li class="chapter" data-level="" data-path="appendix-1-stan-program-style-guide.html"><a href="appendix-1-stan-program-style-guide.html"><i class="fa fa-check"></i>Appendix 1. Stan Program Style Guide</a></li>
<li class="chapter" data-level="" data-path="stan-for-bugs-appendix.html"><a href="stan-for-bugs-appendix.html"><i class="fa fa-check"></i>Appendix 2. Transitioning from BUGS</a></li>
<li><a href="references.html#references"><i style="font-size: 110%; color:#990017;">References</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan User’s Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="custom-probability-functions.chapter" class="section level1">
<h1><span class="header-section-number">18</span> Custom Probability Functions</h1>
<p>Custom distributions may also be implemented directly within Stan’s
programming language. The only thing that is needed is to increment
the total log probability. The rest of the chapter provides examples.</p>
<div id="examples" class="section level2">
<h2><span class="header-section-number">18.1</span> Examples</h2>
<div id="triangle-distribution" class="section level3 unnumbered">
<h3>Triangle distribution</h3>
<p>A simple example is the triangle distribution,
whose density is shaped like an isosceles triangle with corners at
specified bounds and height determined by the constraint that a
density integrate to 1. If <span class="math inline">\(\alpha \in \mathbb{R}\)</span> and <span class="math inline">\(\beta \in \mathbb{R}\)</span>
are the bounds, with <span class="math inline">\(\alpha &lt; \beta\)</span>, then <span class="math inline">\(y \in (\alpha,\beta)\)</span> has
a density defined as follows.
<span class="math display">\[
\mathsf{Triangle}(y | \alpha,\beta)
=
\frac{2}{\beta - \alpha}
\
\left(
1 -
\left|
y - \frac{\alpha + \beta}{\beta - \alpha}
\right|
\right)
\]</span></p>
<p>If <span class="math inline">\(\alpha = -1\)</span>, <span class="math inline">\(\beta = 1\)</span>, and <span class="math inline">\(y \in (-1,1)\)</span>, this reduces to
<span class="math display">\[
\mathsf{Triangle}(y|-1,1) = 1 - |y|.
\]</span>
Consider the following Stan implementation of
<span class="math inline">\(\mathsf{Triangle}(-1,1)\)</span> for sampling.</p>
<pre><code>parameters {
  real&lt;lower=-1,upper=1&gt; y;
}
model {
  target += log1m(fabs(y));
}</code></pre>
<p>The single scalar parameter <code>y</code> is declared as lying in the
interval <code>(-1,1)</code>. The total log probability is
incremented with the joint log probability of all parameters, i.e.,
<span class="math inline">\(\log \mathsf{Triangle}(y|-1,1)\)</span>. This value is coded in Stan as
<code>log1m(fabs(y))</code>. The function <code>log1m</code> is is defined so
that <code>log1m(x)</code> has the same value as <code>log(1.0-x)</code>, but the
computation is faster, more accurate, and more stable.</p>
<p>The constrained type <code>real&lt;lower=-1,upper=1&gt;</code> declared for <code>y</code> is
critical for correct sampling behavior. If the constraint on <code>y</code>
is removed from the program, say by declaring <code>y</code> as having the
unconstrained scalar type <code>real</code>, the program would compile, but
it would produce arithmetic exceptions at run time when the sampler
explored values of <code>y</code> outside of <span class="math inline">\((-1,1)\)</span>.</p>
<p>Now suppose the log probability function were extended to all of
<span class="math inline">\(\mathbb{R}\)</span> as follows by defining the probability to be <code>log(0.0)</code>,
i.e., <span class="math inline">\(-\infty\)</span>, for values outside of <span class="math inline">\((-1,1)\)</span>.</p>
<pre><code>target += log(fmax(0.0,1 - fabs(y)));</code></pre>
<p>With the constraint on <code>y</code> in place, this is just a less
efficient, slower, and less arithmetically stable version of the
original program. But if the constraint on <code>y</code> is removed,
the model will compile and run without arithmetic errors, but will not
sample properly.<a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a></p>
</div>
<div id="exponential-distribution" class="section level3 unnumbered">
<h3>Exponential distribution</h3>
<p>If Stan didn’t happen to include the exponential distribution, it
could be coded directly using the following assignment statement,
where <code>lambda</code> is the inverse scale and <code>y</code> the sampled
variate.</p>
<pre><code>target += log(lambda) - y * lambda;</code></pre>
<p>This encoding will work for any <code>lambda</code> and <code>y</code>; they can
be parameters, data, or one of each, or even local variables.</p>
<p>The assignment statement in the previous paragraph generates
C++ code that is similar to that generated by the following
sampling statement.</p>
<pre><code>y ~ exponential(lambda);</code></pre>
<p>There are two notable differences. First, the sampling statement will
check the inputs to make sure both <code>lambda</code> is positive and
<code>y</code> is non-negative (which includes checking that neither is the
special not-a-number value).</p>
<p>The second difference is that if <code>lambda</code> is not a parameter,
transformed parameter, or local model variable, the sampling statement
is clever enough to drop the <code>log(lambda)</code> term. This results in
the same posterior because Stan only needs the log probability up to
an additive constant. If <code>lambda</code> and <code>y</code> are both
constants, the sampling statement will drop both terms (but still
check for out-of-domain errors on the inputs).</p>
</div>
<div id="bivariate-normal-cumulative-distribution-function" class="section level3 unnumbered">
<h3>Bivariate normal cumulative distribution function</h3>
<p>For another example of user-defined functions, consider the following
definition of the bivariate normal cumulative distribution function
(CDF) with location zero, unit variance, and correlation <code>rho</code>.
That is, it computes
<span class="math display">\[
\mbox{binormal\_cdf}(z_1, z_2, \rho) = \mbox{Pr}[Z_1 &gt; z_1 \mbox{ and } Z_2 &gt; z_2]
\]</span>
where the random 2-vector <span class="math inline">\(Z\)</span> has the distribution
<span class="math display">\[
Z \sim \mathsf{multivariate\ normal}\left(
\begin{bmatrix}
0 \\
0
\end{bmatrix}, \
\begin{bmatrix}
1 &amp; \rho
\\
\rho &amp; 1
\end{bmatrix}
]\right).
\]</span></p>
<p>The following Stan program implements this function,</p>
<pre><code>real binormal_cdf(real z1, real z2, real rho) {
  if (z1 != 0 || z2 != 0) {
    real denom = fabs(rho) &lt; 1.0 ? sqrt((1 + rho) * (1 - rho)) : not_a_number();
    real a1 = (z2 / z1 - rho) / denom;
    real a2 = (z1 / z2 - rho) / denom;
    real product = z1 * z2;
    real delta = product &lt; 0 || (product == 0 &amp;&amp; (z1 + z2) &lt; 0);
    return 0.5 * (Phi(z1) + Phi(z2) - delta) - owens_t(z1, a1) - owens_t(z2, a2);
  }
  return 0.25 + asin(rho) / (2 * pi());
}</code></pre>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="31">
<li id="fn31"><p>The problem is the (extremely!) light tails of the triangle distribution. The standard HMC and NUTS samplers can’t get into the corners of the triangle properly. Because the Stan code declares <code>y</code> to be of type <code>real&lt;lower=-1,upper=1&gt;</code>, the inverse logit transform is applied to the unconstrained variable and its log absolute derivative added to the log probability. The resulting distribution on the logit-transformed <code>y</code> is well behaved.<a href="custom-probability-functions-chapter.html#fnref31" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="functions-programming-chapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="problematic-posteriors-chapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
